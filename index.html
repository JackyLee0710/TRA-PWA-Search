<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµç­æ¬¡å¿«é€ŸæŸ¥è©¢</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* ç‚ºäº†æ›´å¥½çš„ Autocomplete æ¨£å¼ */
        input[list] {
            background-color: white;
        }
        /* å±•é–‹/æ”¶åˆçš„å‹•ç•«æ•ˆæœ */
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-content.expanded {
            max-height: 500px; /* è¨­å®šä¸€å€‹è¶³å¤ å¤§çš„é«˜åº¦ */
        }
        /* ç•¶ PWA ä»¥ç¨ç«‹è¦–çª— (standalone) æ¨¡å¼é‹è¡Œæ™‚ï¼Œéš±è—é€™å€‹æŒ‰éˆ• */
        @media all and (display-mode: standalone), (display-mode: fullscreen), (display-mode: minimal-ui) {
            #installButton {
                display: none !important; 
            }
        }
    </style>
</head>    
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800">å°éµç­æ¬¡å¿«é€ŸæŸ¥è©¢</h1>
            <p class="text-gray-600 mt-2">å³æ™‚æŸ¥è©¢åˆ—è»Šæ™‚åˆ»ã€èª¤é»è³‡è¨Š</p>
            <button id="installButton" style="display: none; background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px auto; display: block;">
                é»æˆ‘å®‰è£ App
            </button>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="fromStation" class="block text-sm font-medium text-gray-700 mb-1">å‡ºç™¼ç«™</label>
                    <input list="stationList" id="fromStation" name="fromStation" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚ï¼šç«¹åŒ—">
                </div>
                
                <div class="text-center">
                    <button id="swapStations" class="p-3 bg-gray-200 text-gray-600 hover:bg-blue-600 hover:text-white rounded-full transition-all duration-300 transform hover:rotate-180">
                        <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 30 30">
                            <path d="M13.78897,6.6557l0,-1.22748l-6.58448,3.80191l6.58448,3.80194l0,-1.3171c1.78674,-0.00084 4.92348,0.15187 4.92348,1.23411c0,1.51215 -3.27596,2.31884 -3.27596,2.31884l0,1.15941c0,0 7.35902,0.25146 7.35902,-5.34311c0,-4.39532 -6.30272,-4.56049 -9.00654,-4.42851z" stroke-width="0"/>
                            <path transform="rotate(180 15 19.0714)" d="m13.78897,14.79844l0,-1.22748l-6.58448,3.80191l6.58448,3.80194l0,-1.3171c1.78674,-0.00084 4.92348,0.15186 4.92348,1.23411c0,1.51215 -3.27596,2.31884 -3.27596,2.31884l0,1.1594c0,0 7.35902,0.25146 7.35902,-5.34311c0,-4.39532 -6.30272,-4.56049 -9.00654,-4.42851z" stroke-width="0"/>
                        </svg>
                    </button>
                </div>

                <div class="md:col-span-2">
                    <label for="toStation" class="block text-sm font-medium text-gray-700 mb-1">ç›®çš„åœ°</label>
                    <input list="stationList" id="toStation" name="toStation" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚ï¼šæ¿æ©‹">
                </div>

                <div class="md:col-span-2">
                    <label for="searchDate" class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                    <input type="date" id="searchDate" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="md:col-span-2">
                    <label for="searchTime" class="block text-sm font-medium text-gray-700 mb-1">æ™‚é–“</label>
                    <input type="time" id="searchTime" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="md:col-span-1">
                    <button id="searchBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md">
                        æŸ¥è©¢
                    </button>
                </div>
            </div>
            <div class="mt-4 flex items-center justify-end">
                <input type="checkbox" id="showAllTrains" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="showAllTrains" class="ml-2 block text-sm text-gray-900">é¡¯ç¤ºæ‰€æœ‰è»Šç¨® (åŒ…å«å°è™Ÿåº§)</label>
            </div>
            <datalist id="stationList"></datalist>
        </div>

        <div id="results" class="space-y-4">
             </div>
        
        <div id="message" class="text-center p-8 text-gray-500"></div>

    </div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2 pointer-events-none"></div>
<script>
    // è®Šæ•¸ç”¨æ–¼å„²å­˜ç€è¦½å™¨ç™¼å‡ºçš„å®‰è£äº‹ä»¶
    let deferredPrompt;
    
    // å–å¾—æŒ‰éˆ•å…ƒç´ 
    const installButton = document.getElementById('installButton');

    // 1. ç›£è½ beforeinstallprompt äº‹ä»¶
    window.addEventListener('beforeinstallprompt', (e) => {
        // é˜»æ­¢ Chrome 67 ä¹‹å‰çš„ç‰ˆæœ¬è‡ªå‹•é¡¯ç¤ºå½ˆçª—
        e.preventDefault();
        
        // å„²å­˜äº‹ä»¶ï¼Œä»¥ä¾¿ä¹‹å¾Œå¯ä»¥æ‰‹å‹•è§¸ç™¼
        deferredPrompt = e;
        
        // é¡¯ç¤ºæ‚¨çš„è‡ªè¨‚å®‰è£æŒ‰éˆ•
        installButton.style.display = 'block';

        console.log('beforeinstallprompt event fired. Install button is now visible.');
    });

    // 2. è™•ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶
    installButton.addEventListener('click', () => {
        if (deferredPrompt) {
            // éš±è—æŒ‰éˆ• (å› ç‚ºæˆ‘å€‘å³å°‡å½ˆå‡ºæç¤º)
            installButton.style.display = 'none';
            
            // è§¸ç™¼ç€è¦½å™¨åŸç”Ÿçš„å®‰è£æç¤º
            deferredPrompt.prompt();
            
            // ç›£è½ä½¿ç”¨è€…å°æç¤ºçš„åæ‡‰
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                // å®‰è£å®Œæˆæˆ–è¢«æ‹’çµ•å¾Œï¼Œæ¸…é™¤å„²å­˜çš„äº‹ä»¶
                deferredPrompt = null;
            });
        }
    });

    // 3. ç›£è½ PWA å®‰è£æˆåŠŸäº‹ä»¶
    window.addEventListener('appinstalled', (e) => {
        console.log('PWA was successfully installed.');
        // ç¢ºä¿å®‰è£å¾ŒæŒ‰éˆ•æ¶ˆå¤±
        installButton.style.display = 'none';
    });
</script>
    <script>
        // ã€æ–°å¢ Service Worker è¨»å†Šç¢¼ã€‘
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker è¨»å†ŠæˆåŠŸï¼Œç¯„åœ: ', registration.scope);
                    })
                    .catch(error => {
                        console.error('ServiceWorker è¨»å†Šå¤±æ•—: ', error);
                    });
            });
        }
        // ã€ç¨‹å¼é€²å…¥é»é–‹å§‹ã€‘
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM å…ƒç´  ---
            const fromStationInput = document.getElementById('fromStation');
            const toStationInput = document.getElementById('toStation');
            const swapStationsBtn = document.getElementById('swapStations');
            const searchDateInput = document.getElementById('searchDate');
            const searchTimeInput = document.getElementById('searchTime');
            const searchBtn = document.getElementById('searchBtn');
            const showAllTrainsCheckbox = document.getElementById('showAllTrains');
            const stationList = document.getElementById('stationList');
            const resultsContainer = document.getElementById('results');
            const messageDiv = document.getElementById('message');

            // --- è³‡æ–™ ---
            const stations = [
                  {"id":"0900","name":"åŸºéš†"},{"id":"0910","name":"ä¸‰å‘"},{"id":"0920","name":"å…«å µ"},{"id":"0930","name":"ä¸ƒå µ"},{"id":"0940","name":"ç™¾ç¦"},{"id":"0950","name":"äº”å µ"},{"id":"0960","name":"æ±æ­¢"},{"id":"0970","name":"æ±ç§‘"},{"id":"0980","name":"å—æ¸¯"},{"id":"0990","name":"æ¾å±±"},{"id":"1000","name":"è‡ºåŒ—"},{"id":"1001","name":"è‡ºåŒ—-ç’°å³¶"},{"id":"1010","name":"è¬è¯"},{"id":"1020","name":"æ¿æ©‹"},{"id":"1030","name":"æµ®æ´²"},{"id":"1040","name":"æ¨¹æ—"},{"id":"1050","name":"å—æ¨¹æ—"},{"id":"1060","name":"å±±ä½³"},{"id":"1070","name":"é¶¯æ­Œ"},{"id":"1075","name":"é³³é³´"},{"id":"1080","name":"æ¡ƒåœ’"},{"id":"1090","name":"å…§å£¢"},{"id":"1100","name":"ä¸­å£¢"},{"id":"1110","name":"åŸ”å¿ƒ"},{"id":"1120","name":"æ¥Šæ¢…"},{"id":"1130","name":"å¯Œå²¡"},{"id":"1140","name":"æ–°å¯Œ"},{"id":"1150","name":"åŒ—æ¹–"},{"id":"1160","name":"æ¹–å£"},{"id":"1170","name":"æ–°è±"},{"id":"1180","name":"ç«¹åŒ—"},{"id":"1190","name":"åŒ—æ–°ç«¹"},{"id":"1191","name":"åƒç”²"},{"id":"1192","name":"æ–°èŠ"},{"id":"1193","name":"ç«¹ä¸­"},{"id":"1194","name":"å…­å®¶"},{"id":"1201","name":"ä¸Šå“¡"},{"id":"1202","name":"æ¦®è¯"},{"id":"1203","name":"ç«¹æ±"},{"id":"1204","name":"æ©«å±±"},{"id":"1205","name":"ä¹è®šé ­"},{"id":"1206","name":"åˆèˆˆ"},{"id":"1207","name":"å¯Œè²´"},{"id":"1208","name":"å…§ç£"},{"id":"1210","name":"æ–°ç«¹"},{"id":"1220","name":"ä¸‰å§“æ©‹"},{"id":"1230","name":"é¦™å±±"},{"id":"1240","name":"å´é ‚"},{"id":"1250","name":"ç«¹å—"},{"id":"2110","name":"è«‡æ–‡"},{"id":"2120","name":"å¤§å±±"},{"id":"2130","name":"å¾Œé¾"},{"id":"2140","name":"é¾æ¸¯"},{"id":"2150","name":"ç™½æ²™å±¯"},{"id":"2160","name":"æ–°åŸ”"},{"id":"2170","name":"é€šéœ„"},{"id":"2180","name":"è‹‘è£¡"},{"id":"2190","name":"æ—¥å—"},{"id":"2200","name":"å¤§ç”²"},{"id":"2210","name":"è‡ºä¸­æ¸¯"},{"id":"2220","name":"æ¸…æ°´"},{"id":"2230","name":"æ²™é¹¿"},{"id":"2240","name":"é¾äº•"},{"id":"2250","name":"å¤§è‚š"},{"id":"2260","name":"è¿½åˆ†"},{"id":"3140","name":"é€ æ©‹"},{"id":"3150","name":"è±å¯Œ"},{"id":"3160","name":"è‹—æ —"},{"id":"3170","name":"å—å‹¢"},{"id":"3180","name":"éŠ…é‘¼"},{"id":"3190","name":"ä¸‰ç¾©"},{"id":"3210","name":"æ³°å®‰"},{"id":"3220","name":"åé‡Œ"},{"id":"3230","name":"è±åŸ"},{"id":"3240","name":"æ —æ—"},{"id":"3250","name":"æ½­å­"},{"id":"3260","name":"é ­å®¶å"},{"id":"3270","name":"æ¾ç«¹"},{"id":"3280","name":"å¤ªåŸ"},{"id":"3290","name":"ç²¾æ­¦"},{"id":"3300","name":"è‡ºä¸­"},{"id":"3310","name":"äº”æ¬Š"},{"id":"3320","name":"å¤§æ…¶"},{"id":"3330","name":"çƒæ—¥"},{"id":"3340","name":"æ–°çƒæ—¥"},{"id":"3350","name":"æˆåŠŸ"},{"id":"3360","name":"å½°åŒ–"},{"id":"3370","name":"èŠ±å£‡"},{"id":"3380","name":"å¤§æ‘"},{"id":"3390","name":"å“¡æ—"},{"id":"3400","name":"æ°¸é–"},{"id":"3410","name":"ç¤¾é ­"},{"id":"3420","name":"ç”°ä¸­"},{"id":"3430","name":"äºŒæ°´"},{"id":"3431","name":"æºæ³‰"},{"id":"3432","name":"æ¿æ°´"},{"id":"3433","name":"é¾æ³‰"},{"id":"3434","name":"é›†é›†"},{"id":"3435","name":"æ°´é‡Œ"},{"id":"3436","name":"è»ŠåŸ•"},{"id":"3450","name":"æ—å…§"},{"id":"3460","name":"çŸ³æ¦´"},{"id":"3470","name":"æ–—å…­"},{"id":"3480","name":"æ–—å—"},{"id":"3490","name":"çŸ³é¾œ"},{"id":"4050","name":"å¤§æ—"},{"id":"4060","name":"æ°‘é›„"},{"id":"4070","name":"å˜‰åŒ—"},{"id":"4080","name":"å˜‰ç¾©"},{"id":"4090","name":"æ°´ä¸Š"},{"id":"4100","name":"å—é–"},{"id":"4110","name":"å¾Œå£"},{"id":"4120","name":"æ–°ç‡Ÿ"},{"id":"4130","name":"æŸ³ç‡Ÿ"},{"id":"4140","name":"æ—é³³ç‡Ÿ"},{"id":"4150","name":"éš†ç”°"},{"id":"4160","name":"æ‹”æ—"},{"id":"4170","name":"å–„åŒ–"},{"id":"4180","name":"å—ç§‘"},{"id":"4190","name":"æ–°å¸‚"},{"id":"4200","name":"æ°¸åº·"},{"id":"4210","name":"å¤§æ©‹"},{"id":"4220","name":"è‡ºå—"},{"id":"4250","name":"ä¿å®‰"},{"id":"4260","name":"ä»å¾·"},{"id":"4270","name":"ä¸­æ´²"},{"id":"4271","name":"é•·æ¦®å¤§å­¸"},{"id":"4272","name":"æ²™å´™"},{"id":"4290","name":"å¤§æ¹–"},{"id":"4300","name":"è·¯ç«¹"},{"id":"4310","name":"å²¡å±±"},{"id":"4320","name":"æ©‹é ­"},{"id":"4330","name":"æ¥ æ¢“"},{"id":"4340","name":"æ–°å·¦ç‡Ÿ"},{"id":"4350","name":"å·¦ç‡Ÿ"},{"id":"4360","name":"å…§æƒŸ"},{"id":"4370","name":"ç¾è¡“é¤¨"},{"id":"4380","name":"é¼“å±±"},{"id":"4390","name":"ä¸‰å¡Šå"},{"id":"4400","name":"é«˜é›„"},{"id":"4410","name":"æ°‘æ—"},{"id":"4420","name":"ç§‘å·¥é¤¨"},{"id":"4430","name":"æ­£ç¾©"},{"id":"4440","name":"é³³å±±"},{"id":"4450","name":"å¾Œåº„"},{"id":"4460","name":"ä¹æ›²å ‚"},{"id":"4470","name":"å…­å¡Šå"},{"id":"5000","name":"å±æ±"},{"id":"5010","name":"æ­¸ä¾†"},{"id":"5020","name":"éºŸæ´›"},{"id":"5030","name":"è¥¿å‹¢"},{"id":"5040","name":"ç«¹ç”°"},{"id":"5050","name":"æ½®å·"},{"id":"5060","name":"å´é ‚"},{"id":"5070","name":"å—å·"},{"id":"5080","name":"é®å®‰"},{"id":"5090","name":"æ—é‚Š"},{"id":"5100","name":"ä½³å†¬"},{"id":"5110","name":"æ±æµ·"},{"id":"5120","name":"æ‹å¯®"},{"id":"5130","name":"åŠ ç¥¿"},{"id":"5140","name":"å…§ç…"},{"id":"5160","name":"æ‹å±±"},{"id":"5170","name":"æ‹é‡"},{"id":"5190","name":"å¤§æ­¦"},{"id":"5200","name":"ç€§æºª"},{"id":"5210","name":"é‡‘å´™"},{"id":"5220","name":"å¤ªéº»é‡Œ"},{"id":"5230","name":"çŸ¥æœ¬"},{"id":"5240","name":"åº·æ¨‚"},{"id":"5998","name":"å—æ–¹å°ç«™"},{"id":"5999","name":"æ½®å·åŸºåœ°"},{"id":"6000","name":"è‡ºæ±"},{"id":"6010","name":"å±±é‡Œ"},{"id":"6020","name":"é¹¿é‡"},{"id":"6030","name":"ç‘æº"},{"id":"6040","name":"ç‘å’Œ"},{"id":"6050","name":"é—œå±±"},{"id":"6060","name":"æµ·ç«¯"},{"id":"6070","name":"æ± ä¸Š"},{"id":"6080","name":"å¯Œé‡Œ"},{"id":"6090","name":"æ±ç«¹"},{"id":"6100","name":"æ±é‡Œ"},{"id":"6110","name":"ç‰é‡Œ"},{"id":"6120","name":"ä¸‰æ°‘"},{"id":"6130","name":"ç‘ç©—"},{"id":"6140","name":"å¯Œæº"},{"id":"6150","name":"å¤§å¯Œ"},{"id":"6160","name":"å…‰å¾©"},{"id":"6170","name":"è¬æ¦®"},{"id":"6180","name":"é³³æ—"},{"id":"6190","name":"å—å¹³"},{"id":"6200","name":"æ—æ¦®æ–°å…‰"},{"id":"6210","name":"è±ç”°"},{"id":"6220","name":"å£½è±"},{"id":"6230","name":"å¹³å’Œ"},{"id":"6240","name":"å¿—å­¸"},{"id":"6250","name":"å‰å®‰"},{"id":"7000","name":"èŠ±è“®"},{"id":"7010","name":"åŒ—åŸ”"},{"id":"7020","name":"æ™¯ç¾"},{"id":"7030","name":"æ–°åŸ"},{"id":"7040","name":"å´‡å¾·"},{"id":"7050","name":"å’Œä»"},{"id":"7060","name":"å’Œå¹³"},{"id":"7070","name":"æ¼¢æœ¬"},{"id":"7080","name":"æ­¦å¡”"},{"id":"7090","name":"å—æ¾³"},{"id":"7100","name":"æ±æ¾³"},{"id":"7110","name":"æ°¸æ¨‚"},{"id":"7120","name":"è˜‡æ¾³"},{"id":"7130","name":"è˜‡æ¾³æ–°"},{"id":"7140","name":"æ–°é¦¬"},{"id":"7150","name":"å†¬å±±"},{"id":"7160","name":"ç¾…æ±"},{"id":"7170","name":"ä¸­é‡Œ"},{"id":"7180","name":"äºŒçµ"},{"id":"7190","name":"å®œè˜­"},{"id":"7200","name":"å››åŸ"},{"id":"7210","name":"ç¤æºª"},{"id":"7220","name":"é ‚åŸ”"},{"id":"7230","name":"é ­åŸ"},{"id":"7240","name":"å¤–æ¾³"},{"id":"7250","name":"é¾œå±±"},{"id":"7260","name":"å¤§æºª"},{"id":"7270","name":"å¤§é‡Œ"},{"id":"7280","name":"çŸ³åŸ"},{"id":"7290","name":"ç¦éš†"},{"id":"7300","name":"è²¢å¯®"},{"id":"7310","name":"é›™æºª"},{"id":"7320","name":"ç‰¡ä¸¹"},{"id":"7331","name":"å¤§è¯"},{"id":"7332","name":"ååˆ†"},{"id":"7333","name":"æœ›å¤"},{"id":"7334","name":"å¶ºè…³"},{"id":"7335","name":"å¹³æºª"},{"id":"7336","name":"èæ¡"},{"id":"7350","name":"çŒ´ç¡"},{"id":"7360","name":"ç‘èŠ³"},{"id":"7361","name":"æµ·ç§‘é¤¨"},{"id":"7362","name":"å…«æ–—å­"},{"id":"7380","name":"å››è…³äº­"},{"id":"7390","name":"æš–æš–"}
            ].sort((a, b) => a.id.localeCompare(b.id));
            
            // --- æ–°å¢ Toast æç¤ºè¨Šæ¯å‡½å¼ (è§£æ±ºå•é¡Œ 3) ---
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const color = type === 'error' ? 'bg-red-500' : (type === 'warn' ? 'bg-yellow-500' : 'bg-green-500');
                const toast = document.createElement('div');
                // è¨­ç½®æ¨£å¼
                toast.className = `${color} text-white px-4 py-2 rounded-lg shadow-xl transition-all duration-300 transform opacity-0 translate-y-4 pointer-events-auto`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-4'); // é€²å…¥å‹•ç•«
                }, 10);

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-4'); // é›¢é–‹å‹•ç•«
                    setTimeout(() => toast.remove(), 300); // ç§»é™¤å…ƒç´ 
                }, 3000);
            }
            
            // --- åˆå§‹åŒ– ---
            function initialize() {
                // å¡«å……è»Šç«™åˆ—è¡¨ï¼Œä¸¦è‡ªå‹•åŠ å…¥ 'å°' çš„åˆ¥å
                stations.forEach(station => {
                    // åŠ å…¥å®˜æ–¹åç¨± (ä¾‹å¦‚ï¼šè‡ºåŒ—)
                    const option = document.createElement('option');
                    option.value = station.name;
                    stationList.appendChild(option);

                    // å¦‚æœç«™ååŒ…å« 'è‡º'ï¼Œå‰‡è‡ªå‹•æ–°å¢ 'å°' çš„ç‰ˆæœ¬ä½œç‚ºé¸é …
                    if (station.name.includes('è‡º')) {
                        const aliasOption = document.createElement('option');
                        aliasOption.value = station.name.replace(/è‡º/g, 'å°');
                        stationList.appendChild(aliasOption);
                    }
                });

                const now = new Date();
                fromStationInput.value = 'ç«¹åŒ—';
                toStationInput.value = 'æ¿æ©‹';
                searchDateInput.value = now.toISOString().split('T')[0];
                searchTimeInput.value = now.toTimeString().split(' ')[0].substring(0, 5);
                showAllTrainsCheckbox.checked = false;

                performSearch();
            }

            // --- äº‹ä»¶ç›£è½ ---
            searchBtn.addEventListener('click', performSearch);
            swapStationsBtn.addEventListener('click', () => {
                [fromStationInput.value, toStationInput.value] = [toStationInput.value, fromStationInput.value];
            });
            showAllTrainsCheckbox.addEventListener('change', performSearch);


            // --- ä¸»è¦åŠŸèƒ½å‡½å¼ ---
            async function performSearch() {
                resultsContainer.innerHTML = '';
                messageDiv.textContent = 'æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...';

                // å°‡ä½¿ç”¨è€…è¼¸å…¥çš„ 'å°' æ¨™æº–åŒ–ç‚º 'è‡º'ï¼Œä»¥ä¾¿å¾ŒçºŒæŸ¥æ‰¾
                const fromStationName = fromStationInput.value.replace(/å°/g, 'è‡º');
                const toStationName = toStationInput.value.replace(/å°/g, 'è‡º');

                const fromStation = stations.find(s => s.name === fromStationName);
                const toStation = stations.find(s => s.name === toStationName);

                if (!fromStation || !toStation) {
                    messageDiv.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„è»Šç«™åç¨±ã€‚';
                    return;
                }
                
                if (fromStation.id === toStation.id) {
                    messageDiv.textContent = 'å‡ºç™¼ç«™èˆ‡ç›®çš„åœ°ä¸å¯ç›¸åŒã€‚';
                    return;
                }

                try {
                    // *** å‘¼å« API å‡½å¼ ***
                    const timetable = await fetchTimetable(fromStation.id, toStation.id, searchDateInput.value);
                    const delays = await fetchDelays();
                    const prices = await fetchPrice(fromStation.id, toStation.id);

                    const filteredTrains = timetable
                        .filter(train => train.OriginStopTime?.DepartureTime >= searchTimeInput.value)
                        .filter(train => {
                            if (showAllTrainsCheckbox.checked) return true;
                            // ä½¿ç”¨å¯é¸ä¸²è¯å®‰å…¨åœ°æª¢æŸ¥è»Šç¨®åç¨±
                            const nonReservedTypes = ['è‡ªå¼·(æ¨æ‹‰å¼è‡ªå¼·è™Ÿä¸”ç„¡è‡ªè¡Œè»Šè»Šå»‚)', 'è’å…‰', 'å€é–“'];
                            return nonReservedTypes.some(type => train.DailyTrainInfo?.TrainTypeName?.Zh_tw?.includes(type));
                        })
                        .slice(0, 5);

                    if (filteredTrains.length === 0) {
                        messageDiv.textContent = 'æŸ¥è©¢ç„¡çµæœï¼Œè«‹å˜—è©¦èª¿æ•´æ™‚é–“æˆ–æ—¥æœŸã€‚';
                    } else {
                        messageDiv.textContent = '';
                        renderResults(filteredTrains, delays, prices);
                    }

                } catch (error) {
                    console.error('æŸ¥è©¢å¤±æ•—:', error);
                    // é€™è£¡æœƒé¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                    messageDiv.textContent = `æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
                }
            }

            function renderResults(trains, delays, prices) {
                resultsContainer.innerHTML = '';
                const currentFromStationId = document.getElementById('fromStation').value;
                const currentToStationId = document.getElementById('toStation').value;

                trains.forEach(train => {
                    const trainNo = train.DailyTrainInfo.TrainNo;
                    const delayInfo = delays.find(d => d.TrainNo === trainNo);
                    const delayMinutes = delayInfo ? delayInfo.DelayTime : 0;
                    const trainTypeName = train.DailyTrainInfo?.TrainTypeName?.Zh_tw || 'æœªçŸ¥è»Šç¨®';
                    const originStationName = train.OriginStopTime?.StationName?.Zh_tw || 'æœªçŸ¥è»Šç«™';
                    const destinationStationName = train.DestinationStopTime?.StationName?.Zh_tw || 'æœªçŸ¥è»Šç«™';
                    const startingStationName = train.DailyTrainInfo?.StartingStationName?.Zh_tw || 'æœªçŸ¥è»Šç«™';
                    const endingStationName = train.DailyTrainInfo?.EndingStationName?.Zh_tw || 'æœªçŸ¥è»Šç«™';
                    const trainDirection = train.DailyTrainInfo?.Direction;

                    // å–å¾—ç¥¨åƒ¹ï¼ŒåŒæ™‚æª¢æŸ¥è»Šç¨®åç¨±èˆ‡è¡Œé§›æ–¹å‘
                    const priceInfo = prices.find(p => p.FareClasses && p.FareClasses.some(className => trainTypeName.includes(className)) && p.Direction === trainDirection);
                    const fareText = priceInfo ? `$${priceInfo.Price}` : 'ç„¡ç¥¨åƒ¹è³‡è¨Š';
                    const easycardPrice = priceInfo ? `$${priceInfo.EasyCard}` : 'ç„¡ç¥¨åƒ¹è³‡è¨Š';
                    
                    const isTracking = isTrainTracking(trainNo);
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-md overflow-hidden cursor-pointer transition-transform transform hover:scale-105';
                    card.innerHTML = `
                        <div class="p-4 md:p-6 relative">
                            <button data-train-no="${trainNo}" class="track-btn absolute top-3 right-3 p-2 rounded-full transition-colors ${isTracking ? 'text-red-500 bg-red-100 hover:bg-red-200' : 'text-gray-400 bg-gray-100 hover:bg-blue-200 hover:text-blue-600'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="${isTracking ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isTracking ? 'M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3zm2-14V5m0 0a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2h7a2 2 0 002-2v-3' : 'M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.054 5.925 5 8.528 5 11v3.159c0 .538-.214 1.055-.595 1.436L3 17h5m5 0a1 1 0 01-1 1H8a1 1 0 01-1-1m1-4h.01'}"/>
                                </svg>
                            </button>

                            <div class="grid grid-cols-12 gap-2 items-center">
                                <div class="col-span-12 md:col-span-3 text-center md:text-left">
                                    <span class="text-xl font-bold ${getTrainTypeColor(trainTypeName)}">${trainTypeName}</span>
                                    <p class="text-sm text-gray-500">${trainNo} æ¬¡</p>
                                </div>
                                <div class="col-span-5 md:col-span-3 text-center">
                                    <p class="text-2xl font-semibold">${train.OriginStopTime?.DepartureTime || '--:--'}</p>
                                    <p class="text-gray-600">${originStationName}</p>
                                </div>
                                <div class="col-span-2 md:col-span-3 text-center">
                                    <p class="text-gray-400 text-sm">${calculateDuration(train.OriginStopTime?.DepartureTime, train.DestinationStopTime?.ArrivalTime)}</p>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                    </svg>
                                </div>
                                <div class="col-span-5 md:col-span-3 text-center">
                                    <p class="text-2xl font-semibold">${train.DestinationStopTime?.ArrivalTime || '--:--'}</p>
                                    <p class="text-gray-600">${destinationStationName}</p>
                                </div>
                            </div>
                        </div>
                        <div class="details-content bg-gray-50 border-t border-gray-200">
                            <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div><p class="text-sm text-gray-500">èµ·è¨–ç«™é»</p><p class="font-semibold">${startingStationName} -> ${endingStationName}</p></div>
                                <div><p class="text-sm text-gray-500">ç›®å‰ç‹€æ…‹</p><p class="font-semibold ${delayMinutes > 0 ? 'text-red-500' : 'text-green-500'}">${delayMinutes > 0 ? `æ™š ${delayMinutes} åˆ†` : 'æº–é»'}</p></div>
                                <div><p class="text-sm text-gray-500">å…¨ç¥¨ç¥¨åƒ¹</p><p class="font-semibold">${fareText}</p></div>
                                <div><p class="text-sm text-gray-500">æ‚ éŠå¡åƒ¹æ ¼</p><p class="font-semibold">${easycardPrice === '$0' ? 'é›»å­ç¥¨åˆ¸ä¸å¯æ­ä¹˜' : `${easycardPrice}`}</p></div>
                        </div>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', (e) => {
                        // é»æ“ŠæŒ‰éˆ•ä¸è§¸ç™¼å¡ç‰‡å±•é–‹/æ”¶åˆ
                        if (!e.target.closest('.track-btn')) {
                            card.querySelector('.details-content').classList.toggle('expanded');
                        }
                    });

                    // ğŸš© è¿½è¹¤æŒ‰éˆ•äº‹ä»¶ç›£è½
                    card.querySelector('.track-btn').addEventListener('click', async (e) => {
                        e.stopPropagation(); // é˜»æ­¢å¡ç‰‡å±•é–‹
                        const trainNo = e.currentTarget.dataset.trainNo;
                        const isCurrentlyTracking = isTrainTracking(trainNo);
                        const button = e.currentTarget; // æ•æ‰æŒ‰éˆ•å…ƒç´ ï¼Œç¢ºä¿å¼•ç”¨ä¸æœƒä¸Ÿå¤±
                        // ã€ä¿®æ­£é» 1ï¼šç¢ºä¿ Station ID æŸ¥æ‰¾æ­£ç¢ºã€‘
                        // 1. å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„è»Šç«™åç¨±
                        const currentFromStationName = fromStationInput.value.replace(/å°/g, 'è‡º');
                        const currentToStationName = toStationInput.value.replace(/å°/g, 'è‡º');
                        
                        // 2. é€éåç¨±æŸ¥æ‰¾å¯¦éš›çš„ Station ID ç‰©ä»¶
                        const fromStation = stations.find(s => s.name === currentFromStationName);
                        const toStation = stations.find(s => s.name === currentToStationName);
            
                        if (!fromStation || !toStation) {
                             showToast('è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„èµ·ç«™å’Œè¿„ç«™åç¨±ã€‚', 'error');
                             return;
                        }
                        
                        if (isCurrentlyTracking) {
                            // ç§»é™¤è¿½è¹¤
                            updateTrackingList(trainNo, null, null, 'remove');
                            // ã€ä¿®æ­£é» 2ï¼šUI æ›´æ–°ï¼Œä½¿ç”¨æ•æ‰åˆ°çš„ button è®Šæ•¸ã€‘
                            button.classList.remove('text-red-500', 'bg-red-100', 'hover:bg-red-200');
                            button.classList.add('text-gray-400', 'bg-gray-100', 'hover:bg-blue-200', 'hover:text-blue-600');
                            
                            // ... (SVG åœ–ç¤ºåˆ‡æ›é‚è¼¯) ...
                            showToast(`${trainNo} æ¬¡åˆ—è»Šè¿½è¹¤å·²å–æ¶ˆã€‚`, 'warn');

                        } else {
                            // æ–°å¢è¿½è¹¤
                            const permissionGranted = await requestNotificationPermission();
                            
                            if (permissionGranted) {
                                // ã€ä¿®æ­£é» 1ï¼šå‚³éæ­£ç¢ºçš„ Station ID (fromStation.id)ã€‘
                                updateTrackingList(trainNo, fromStation.id, toStation.id, 'add');
                                
                                // ã€ä¿®æ­£é» 2ï¼šUI æ›´æ–°ï¼Œä½¿ç”¨æ•æ‰åˆ°çš„ button è®Šæ•¸ã€‘
                                button.classList.remove('text-gray-400', 'bg-gray-100', 'hover:bg-blue-200', 'hover:text-blue-600');
                                button.classList.add('text-red-500', 'bg-red-100', 'hover:bg-red-200');
                                
                                // ... (SVG åœ–ç¤ºåˆ‡æ›é‚è¼¯) ...
                                showToast(`${trainNo} æ¬¡åˆ—è»Šè¿½è¹¤å·²å•Ÿç”¨ï¼`, 'success');
                            } else {
                                showToast('ç„¡æ³•è¨­å®šè¿½è¹¤ï¼Œè«‹æˆäºˆé€šçŸ¥æ¬Šé™ã€‚', 'error');
                            }
                        }
                    });

                    resultsContainer.appendChild(card);
                });
            }

            // --- è¼”åŠ©å‡½å¼ ---
            function getTrainTypeColor(typeName) {
                if (typeName.includes('æ™®æ‚ ç‘ª') || typeName.includes('å¤ªé­¯é–£')) return 'text-red-600';
                if (typeName.includes('è‡ªå¼·')) return 'text-orange-600';
                if (typeName.includes('è’å…‰')) return 'text-blue-600';
                if (typeName.includes('å€é–“')) return 'text-green-600';
                return 'text-gray-800';
            }

            function calculateDuration(start, end) {
                if (!start || !end) return 'ç„¡è³‡æ–™';
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                let diff = (endH * 60 + endM) - (startH * 60 + startM);
                if (diff < 0) diff += 24 * 60;
                const h = Math.floor(diff / 60);
                const m = diff % 60;
                return `${h > 0 ? h + ' å°æ™‚ ' : ''}${m} åˆ†`;
            }
            // --- æ–°å¢è¿½è¹¤åŠŸèƒ½ç›¸é—œå‡½å¼ ---
            
            // 1. æª¢æŸ¥ä¸¦è«‹æ±‚é€šçŸ¥æ¬Šé™
            async function requestNotificationPermission() {
                if (!('Notification' in window)) {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½ã€‚');
                    return false;
                }
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    alert('é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•ï¼Œç„¡æ³•ä½¿ç”¨åˆ—è»Šè¿½è¹¤åŠŸèƒ½ã€‚');
                    return false;
                }
                return true;
            }
            
            // 2. ç®¡ç† LocalStorage ä¸­çš„è¿½è¹¤æ¸…å–®
            const TRACKING_KEY = 'tra_tracking_list';
            
            function getTrackingList() {
                const list = localStorage.getItem(TRACKING_KEY);
                return list ? JSON.parse(list) : [];
            }
            
            function updateTrackingList(trainNo, fromStationId, toStationId, action = 'add') {
                let list = getTrackingList();
                const trainIndex = list.findIndex(t => t.trainNo === trainNo);
            
                if (action === 'add' && trainIndex === -1) {
                    list.push({
                        trainNo: trainNo,
                        fromStationId: fromStationId,
                        toStationId: toStationId,
                        timestamp: Date.now()
                    });
                    console.log(`å·²åŠ å…¥è¿½è¹¤: ${trainNo}`);
                } else if (action === 'remove' && trainIndex !== -1) {
                    list.splice(trainIndex, 1);
                    console.log(`å·²ç§»é™¤è¿½è¹¤: ${trainNo}`);
                }
            
                localStorage.setItem(TRACKING_KEY, JSON.stringify(list));
                // å‘ŠçŸ¥ Service Worker æ¸…å–®å·²æ›´æ–° (é€™éƒ¨åˆ†å°‡åœ¨ SW è¨»å†Šå¾Œè™•ç†ï¼Œæ­¤è™•å…ˆä¿æŒç°¡æ½”)
                if (navigator.serviceWorker.controller) {
                     navigator.serviceWorker.controller.postMessage({
                        type: 'TRACKING_LIST_UPDATED',
                        list: list
                    });
                }
                
                return list;
            }
            
            function isTrainTracking(trainNo) {
                return getTrackingList().some(t => t.trainNo === trainNo);
            }
            // --- çœŸå¯¦ API ä¸²æ¥ ---
            // æ­¥é©Ÿ 1: å‰å¾€ https://tdx.transportdata.tw/ è¨»å†Šæœƒå“¡ä¸¦å–å¾— API Key (Client ID & Client Secret)
            // æ­¥é©Ÿ 2: å°‡æ‚¨çš„ Key å¡«å…¥ä¸‹æ–¹
            const TDX_CLIENT_ID = 'jacky841026-3f8ab20a-1893-42cc';
            const TDX_CLIENT_SECRET = 'd44c0656-19f7-4ae5-86a5-f8feba4ecf71';
            let tdxAccessToken = null;

            // æª¢æŸ¥ API Key æ˜¯å¦å·²å¡«å¯«
            function isKeyProvided() {
                return TDX_CLIENT_ID !== '' && TDX_CLIENT_SECRET !== '';
            }

            // ç²å– TDX API èªè­‰ Token
            async function getTdxAccessToken() {
                if (tdxAccessToken) return tdxAccessToken; // å¦‚æœå·²ç¶“æœ‰ tokenï¼Œç›´æ¥å›å‚³

                const authUrl = 'https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token';
                const params = new URLSearchParams();
                params.append('grant_type', 'client_credentials');
                params.append('client_id', TDX_CLIENT_ID);
                params.append('client_secret', TDX_CLIENT_SECRET);

                const response = await fetch(authUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 429) {
                        // ç•¶è¶…éé »ç‡é™åˆ¶æ™‚ï¼Œæ‹‹å‡ºæ›´æ˜ç¢ºçš„éŒ¯èª¤
                        throw new Error(`API è«‹æ±‚é »ç‡è¶…éé™åˆ¶ã€‚è«‹ç¨å¾Œå†è©¦ã€‚`);
                    }
                    throw new Error(`ç„¡æ³•å–å¾— TDX Access Tokenï¼Œè«‹æª¢æŸ¥æ‚¨çš„ ID å’Œ Secretã€‚éŒ¯èª¤è¨Šæ¯: ${errorData.message}`);
                }
                
                const data = await response.json();
                tdxAccessToken = data.access_token;
                return tdxAccessToken;
            }

            // [çœŸå¯¦] ç²å–ç­æ¬¡è³‡æ–™
            async function fetchTimetable(fromStationId, toStationId, date) {
                // å¦‚æœæ²’æœ‰å¡«å¯« API Keyï¼Œå‰‡ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ä¸¦é¡¯ç¤ºæç¤º
                if (!isKeyProvided()) {
                    console.warn("æœªæä¾› TDX API Keyï¼Œå°‡ä½¿ç”¨é›¢ç·šæ¨¡æ“¬è³‡æ–™ã€‚");
                    messageDiv.innerHTML = `âš ï¸ ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ä¸­ã€‚<br>è«‹å‰å¾€ <a href="https://tdx.transportdata.tw/" target="_blank" class="text-blue-600 hover:underline">TDX å¹³å°</a> ç”³è«‹å…è²» API Key ä»¥å–å¾—å³æ™‚è³‡è¨Šã€‚`;
                    return mockFetchTimetable(fromStationId, toStationId, date);
                }

                try {
                    const token = await getTdxAccessToken();
                    const apiUrl = `https://tdx.transportdata.tw/api/basic/v2/Rail/TRA/DailyTimetable/OD/${fromStationId}/to/${toStationId}/${date}?$format=JSON`;
                    
                    const response = await fetch(apiUrl, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        // ğŸ’¡ ã€ä¿®æ­£é»ã€‘: é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                        throw new Error(`ç„¡æ³•å¾ TDX API ç²å–ç­æ¬¡è³‡æ–™ã€‚éŒ¯èª¤ä»£ç¢¼: ${response.status}ã€‚è©³ç´°éŒ¯èª¤: ${errorData.message || 'æœªçŸ¥'}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('æŸ¥è©¢ç­æ¬¡è³‡æ–™å¤±æ•—:', error);
                    // ğŸ’¡ ã€ä¿®æ­£é»ã€‘: å°‡éŒ¯èª¤é‡æ–°æ‹‹å‡ºï¼Œè®“ performSearch é¡¯ç¤ºæ›´ç²¾ç¢ºçš„éŒ¯èª¤è¨Šæ¯
                    throw error;
                }
            }

            // [çœŸå¯¦] ç²å–èª¤é»è³‡æ–™
            async function fetchDelays() {
                 if (!isKeyProvided()) {
                    return mockFetchDelays(); // Key æ²’å¡«å°±å›å‚³æ¨¡æ“¬è³‡æ–™
                }
                try {
                    const token = await getTdxAccessToken();
                    const apiUrl = 'https://tdx.transportdata.tw/api/basic/v2/Rail/TRA/LiveBoard?&format=JSON';

                    const response = await fetch(apiUrl, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        console.error("ç„¡æ³•ç²å–å³æ™‚èª¤é»è³‡è¨Š");
                        return []; // å¤±æ•—æ™‚å›å‚³ç©ºé™£åˆ—
                    }
                    const liveData = await response.json();
                    // æ•´ç†æˆæˆ‘å€‘éœ€è¦çš„æ ¼å¼ { TrainNo, DelayTime }
                    return liveData.map(item => ({ TrainNo: item.TrainNo, DelayTime: item.DelayTime }));
                } catch (error) {
                    console.error('æŸ¥è©¢èª¤é»è³‡æ–™å¤±æ•—:', error);
                    return [];
                }
            }
            
            // [çœŸå¯¦] ç²å–ç¥¨åƒ¹è³‡æ–™ (å·²ä¿®æ­£ï¼šåŠ å…¥è¡Œé§›æ–¹å‘åƒæ•¸)
            async function fetchPrice(fromStationId, toStationId) {
                if (!isKeyProvided()) {
                    return mockFetchPrice(); // Key æ²’å¡«å°±å›å‚³æ¨¡æ“¬è³‡æ–™
                }
                
                // TDX v3 çš„ TrainType ç·¨è™Ÿå°æ‡‰
                const trainTypeMap = {
                    '1': ['å¤ªé­¯é–£(å¤ªé­¯é–£)', 'å¤ªé­¯é–£'],
                    '2': ['æ™®æ‚ ç‘ª(æ™®æ‚ ç‘ª)', 'æ™®æ‚ ç‘ª'],
                    '3': [
                        'è‡ªå¼·(DMU2800ã€2900ã€3000 å‹æŸ´è¯åŠ EMU å‹é›»è»Š)',
                        'è‡ªå¼·(æ¨æ‹‰å¼è‡ªå¼·è™Ÿ)',
                        'è‡ªå¼·(DMU3100 å‹æœ‰èº«éšœåº§ä½æŸ´è¯)',
                        'è‡ªå¼·(å°ˆé–‹åˆ—è»Š)',
                        'è‡ªå¼·(éƒµè¼ªå¼åˆ—è»Š)',
                        'è‡ªå¼·(å•†å‹™å°ˆé–‹åˆ—è»Š)',
                        'è‡ªå¼·(æ¨æ‹‰å¼è‡ªå¼·è™Ÿä¸”ç„¡è‡ªè¡Œè»Šè»Šå»‚)',
                        'è‡ªå¼·(æ¨æ‹‰å¼è‡ªå¼·è™Ÿä¸”æœ‰è‡ªè¡Œè»Šè»Šå»‚)',
                        'è‡ªå¼·(EMU1200 å‹é›»è»Š)',
                        'è‡ªå¼·(EMU300 å‹é›»è»Š)',
                        'è‡ªå¼·(DMU2800 å‹æŸ´è¯)',
                        'è‡ªå¼·(DMU2900 å‹æŸ´è¯)',
                        'è‡ªå¼·(DMU3100 å‹æŸ´è¯)',
                        'è‡ªå¼·' // æ–°å¢çš„é€šç”¨åç¨±
                    ],
                    '4': [
                        'è’å…‰(ç„¡èº«éšœåº§ä½)',
                        'è’å…‰(æœ‰èº«éšœåº§ä½)',
                        'è’å…‰(å°ˆé–‹åˆ—è»Š)',
                        'è’å…‰(éƒµè¼ªå¼åˆ—è»Š)',
                        'è’å…‰(ç„¡èº«éšœåº§ä½, æœ‰è‡ªè¡Œè»Šè»Šå»‚)',
                        'è’å…‰(æœ‰èº«éšœåº§ä½, æœ‰è‡ªè¡Œè»Šè»Šå»‚)',
                        'è’å…‰' // æ–°å¢çš„é€šç”¨åç¨±
                    ],
                    '5': [
                        'å¾©èˆˆ',
                        'å¾©èˆˆ(å°ˆé–‹åˆ—è»Š)',
                        'å¾©èˆˆ(éƒµè¼ªå¼åˆ—è»Š)',
                        'å¾©èˆˆ'
                    ],
                    '6': [
                        'å€é–“(å°ˆé–‹åˆ—è»Š)',
                        'å€é–“',
                        'å€é–“(éƒµè¼ªå¼åˆ—è»Š)',
                        'å€é–“(æœ‰èº«éšœåº§ä½, æœ‰è‡ªè¡Œè»Šè»Šå»‚)',
                        'å€é–“(EMU500 å‹)',
                        'å€é–“(EMU700 å‹)',
                        'å€é–“(EMU800 å‹)',
                        'å€é–“(EMU900 å‹)'
                    ],
                    '7': [
                        'æ™®å¿«',
                        'æ™®å¿«(å°ˆé–‹åˆ—è»Š)'
                    ],
                    '10': ['å€é–“å¿«'],
                    '11': ['è‡ªå¼·(3000)(EMU3000 å‹é›»è»Š)']
                };

                try {
                    const token = await getTdxAccessToken();
                    const apiUrl = `https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/ODFare/${fromStationId}/to/${toStationId}?$format=JSON`;
                    
                    const response = await fetch(apiUrl, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                         if (response.status === 429) {
                            throw new Error(`API è«‹æ±‚é »ç‡è¶…éé™åˆ¶ã€‚è«‹ç¨å¾Œå†è©¦ã€‚`);
                        }
                        console.error("ç„¡æ³•ç²å–ç¥¨åƒ¹è³‡è¨Šï¼Œè«‹æª¢æŸ¥ API Keyã€‚", errorData);
                        return []; 
                    }
                    const fareData = await response.json();
                    
                    // æª¢æŸ¥å›å‚³è³‡æ–™çš„çµæ§‹æ˜¯å¦ç‚ºé æœŸç‰©ä»¶ï¼Œä¸¦å¾ ODFares é™£åˆ—ä¸­å–è³‡æ–™
                    if (!fareData || !Array.isArray(fareData.ODFares)) {
                        console.error("TDX API ç¥¨åƒ¹è³‡æ–™å›å‚³æ ¼å¼éé™£åˆ—", fareData);
                        return [];
                    }
                    
                    // ä¿®æ­£: éæ­·æ¯å€‹ç¥¨åƒ¹é …ç›®ï¼Œä¸¦ä½¿ç”¨ `trainTypeMap` æ‰¾åˆ°å°æ‡‰çš„è»Šç¨®åç¨±
                    return fareData.ODFares.map(item => {
                        const fareClassNames = trainTypeMap[item.TrainType] || ['æœªçŸ¥è»Šç¨®']; // å–å¾—æ‰€æœ‰å¯èƒ½çš„è»Šç¨®åç¨±
                        const price = (item.Fares && item.Fares.length > 0) ? item.Fares[0].Price : null;
                        const direction = item.Direction; // æ–°å¢æ–¹å‘è³‡è¨Š
                        const distance = item.TravelDistance; // æ–°å¢è·é›¢è³‡è¨Š

                        // è¨ˆç®—æ‚ éŠå¡ç¥¨åƒ¹
                        const priceInterval = [50, 100, 200, 300, 99999]; // æ”¶è²»é‡Œç¨‹ç´šè·
                        const priceIntervalDiff = [50, 50, 100, 100, 99999];
                        const priceByType = {'1': 'é›»å­ç¥¨åˆ¸ä¸é©ç”¨', '2': 'é›»å­ç¥¨åˆ¸ä¸é©ç”¨', '3': [2.18, 2.98, 2.81, 2.37, 2.20], '4': [2.18, 1.92, 1.81, 1.53, 1.42], '5': 'é›»å­ç¥¨åˆ¸ä¸é©ç”¨', '6': [2.18, 1.92, 1.81, 1.53, 1.42], '7': 'é›»å­ç¥¨åˆ¸ä¸é©ç”¨', '10': [2.18, 1.92, 1.81, 1.53, 1.42], '11': 'é›»å­ç¥¨åˆ¸ä¸é©ç”¨'}; // è»Šç¨®æ”¶è²»æ–¹å¼
                        let easycardPrice = 0;
                        const priceType = priceByType[item.TrainType];
                        if (priceType === 'é›»å­ç¥¨åˆ¸ä¸é©ç”¨') {
                            easycardPrice = 0;
                        }else{
                            easycardPrice = (distance <= priceInterval[0]) ? Math.max(distance * priceType[0], priceType[0]*10) : 0;
                            // é‡Œç¨‹å°æ–¼åå…¬é‡Œæ™‚ï¼Œæœ€ä½ç¥¨åƒ¹ç‚ºåå…¬é‡Œ

                            // ç”¨è¿´åœˆç¢ºèªé‡Œç¨‹å€é–“
                            for (let i = 1; i < priceInterval.length && easycardPrice === 0; i++) {
                                if (priceInterval[i] > distance) {
                                    easycardPrice += (distance - priceInterval[i-1]) * priceByType[item.TrainType][i];
                                    for (let j = 0; j < priceByType[item.TrainType].slice(0, i).length; j++) {
                                        easycardPrice += priceByType[item.TrainType][j] * priceIntervalDiff[j];
                                    }
                                }
                            }

                        }

                        // å›å‚³ä¸€å€‹ç‰©ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å¯èƒ½çš„è»Šç¨®åç¨±
                        return {
                            FareClasses: fareClassNames,
                            Price: price,
                            Direction: direction,
                            Distance: distance,
                            EasyCard: Math.round(easycardPrice)
                        };
                    });
                } catch (error) {
                    console.error('ç²å–ç¥¨åƒ¹è³‡è¨Šå¤±æ•—:', error);
                    return [];
                }
            }

            // --- æ¨¡æ“¬ API (ä½œç‚ºæœªå¡«å¯« Key æ™‚çš„å‚™ç”¨) ---
            async function mockFetchTimetable(fromStationId, toStationId, date) {
                await new Promise(resolve => setTimeout(resolve, 500));
                const mockData = [
                    { DailyTrainInfo: { TrainNo: '175', Direction: 0, TrainTypeID: '1102', TrainTypeName: { Zh_tw: 'è‡ªå¼·' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '12:05', Platform: '1' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '13:01' }, Note: 'æ¯æ—¥è¡Œé§›' },
                    { DailyTrainInfo: { TrainNo: '119', Direction: 0, TrainTypeID: '1101', TrainTypeName: { Zh_tw: 'è‡ªå¼·' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '12:38', Platform: '1' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '13:28' }, Note: 'æ¯æ—¥è¡Œé§›' },
                    { DailyTrainInfo: { TrainNo: '1251', Direction: 0, TrainTypeID: '1131', TrainTypeName: { Zh_tw: 'å€é–“' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '13:02', Platform: '2A' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '14:10' }, Note: '' },
                    { DailyTrainInfo: { TrainNo: '121', Direction: 0, TrainTypeID: '1100', TrainTypeName: { Zh_tw: 'è‡ªå¼·' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '13:38', Platform: '1' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '14:28' }, Note: 'æ¯æ—¥è¡Œé§›' },
                    { DailyTrainInfo: { TrainNo: '273', Direction: 0, TrainTypeID: '1108', TrainTypeName: { Zh_tw: 'æ™®æ‚ ç‘ª' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '14:18', Platform: '1' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '15:05' }, Note: 'æ¯æ—¥è¡Œé§›' },
                    { DailyTrainInfo: { TrainNo: '1255', Direction: 0, TrainTypeID: '1131', TrainTypeName: { Zh_tw: 'å€é–“' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '14:26', Platform: '2A' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '15:35' }, Note: 'æ¯æ—¥è¡Œé§›' },
                    { DailyTrainInfo: { TrainNo: '123', Direction: 0, TrainTypeID: '1101', TrainTypeName: { Zh_tw: 'è‡ªå¼·' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '14:38', Platform: '1' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '15:28' }, Note: 'é€¢é€±äº”è‡³æ—¥è¡Œé§›ã€‚' },
                    { DailyTrainInfo: { TrainNo: '521', Direction: 0, TrainTypeID: '1110', TrainTypeName: { Zh_tw: 'è’å…‰' } }, OriginStopTime: { StationID: '1170', StationName: { Zh_tw: 'ç«¹åŒ—' }, DepartureTime: '15:05', Platform: '1' }, DestinationStopTime: { StationID: '1020', StationName: { Zh_tw: 'æ¿æ©‹' }, ArrivalTime: '16:15' }, Note: 'é€¢é€±äº”è‡³æ—¥è¡Œé§›ã€‚' },
                ];
                return mockData.filter(train => 
                    train.OriginStopTime.StationName.Zh_tw === stations.find(s=>s.id === fromStationId).name &&
                    train.DestinationStopTime.StationName.Zh_tw === stations.find(s=>s.id === toStationId).name
                );
            }
            
            async function mockFetchDelays() {
                await new Promise(resolve => setTimeout(resolve, 200));
                return [
                    { TrainNo: '175', DelayTime: 0 }, { TrainNo: '119', DelayTime: 5 },
                    { TrainNo: '273', DelayTime: 0 }, { TrainNo: '521', DelayTime: 12 },
                ];
            }

            async function mockFetchPrice() {
                await new Promise(resolve => setTimeout(resolve, 200));
                return [
                    { FareClasses: ['æ™®æ‚ ç‘ª(æ™®æ‚ ç‘ª)', 'æ™®æ‚ ç‘ª'], Price: 150, Direction: 0 },
                    { FareClasses: ['è‡ªå¼·(æ¨æ‹‰å¼è‡ªå¼·è™Ÿä¸”ç„¡è‡ªè¡Œè»Šè»Šå»‚)', 'è‡ªå¼·'], Price: 140, Direction: 0 },
                    { FareClasses: ['è’å…‰'], Price: 108, Direction: 0 },
                    { FareClasses: ['å€é–“'], Price: 80, Direction: 0 }
                ];
            }

            // --- ç¨‹å¼é€²å…¥é» ---
            initialize();
        });
    </script>
</body>
</html>
